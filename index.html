<!DOCTYPE html>
<html lang="ja" dir="ltr">
  <head>
    <meta charset="utf-8">
    <title>勤怠管理 送信</title>
    <script type="text/javascript" src="./lib/jQuery.js"></script>
    <link rel="stylesheet" media="screen" href="./lib/font.css">
    <script type="text/javascript" charset="utf-8" src="./lib/setup_icon.js"></script>
    <link rel="stylesheet" media="screen" href="./lib/layout.menu.css">
    <script type="text/javascript" charset="utf-8" src="./lib/toolbox.menu.js"></script>
    <link rel="stylesheet" media="screen" href="./lib/layout.timetable.css">
    <script type="text/javascript" charset="utf-8" src="./lib/getTimer.js"></script>
    <script type="text/javascript" charset="utf-8" src="./lib/isJSON.js"></script>

    <meta name="viewport" content="width=device-width,initial-scale=1">
    <link rel="manifest" href="./lib/manifest.json">
    <script type="text/javascript">
      // Service Worker 登録
      localStorage.setItem( (btoa(location.href)).slice(0, 16) + '.ServiceWorker', JSON.stringify({token: ''}) );
      if ('serviceWorker' in navigator) {
        navigator.serviceWorker.register('./lib/ServiceWorker.js').then(function(registration) {
          localStorage.setItem( (btoa(location.href)).slice(0, 16) + '.ServiceWorker', JSON.stringify({token: registration.scope}) );
        }).catch(function(err) {
          console.error('ServiceWorker registration failed. ');
          console.error(err);
        });
      } else {
        if (location.protocol != 'https:') {
          console.error('ServiceWorker registration failed. Not supported on http.');
        } else {
          console.error('ServiceWorker registration failed. Not supported on this browser.');
        }
      }
    </script>

    <script type="text/javascript" src="https://www.google.com/recaptcha/api.js?render=6LfCHdcUAAAAAOwkHsW_7W7MfoOrvoIw9CXdLRBA"></script>
    <script type="text/javascript">
      /*
       * Admin console url is 'https://www.google.com/recaptcha/admin'
       * Site key is '6LfCHdcUAAAAAOwkHsW_7W7MfoOrvoIw9CXdLRBA' (Use in 2 place)
       */
      grecaptcha.ready(function() {
        grecaptcha.execute('6LfCHdcUAAAAAOwkHsW_7W7MfoOrvoIw9CXdLRBA', {action: 'homepage'}).then(function(token) {
          localStorage.setItem( (btoa(location.href)).slice(0, 16) + '.reCAPTCHA', JSON.stringify({token: token}) );
        });
      });
    </script>

    <script type="text/javascript">
      function targetMonth_shift(offset){
        var targetMonth = JSON.parse(localStorage.getItem( (btoa(location.href)).slice(0, 16) + '.targetMonth' ));
        console.log( targetMonth );

        var targetMonthCurrent = new Date( Number(targetMonth['year']), Number(targetMonth['month']) - offset, 1);
        targetMonthCurrent.setMonth( targetMonthCurrent.getMonth() - offset);

        targetMonth.year  = ( '0000' + ( targetMonthCurrent.getFullYear() ) ).slice(-4);
        targetMonth.month = ( '00'   + ( targetMonthCurrent.getMonth() + 1 ) ).slice(-2);

        localStorage.setItem( (btoa(location.href)).slice(0, 16) + '.targetMonth', JSON.stringify(targetMonth) );
        $('a[href="#page_reload"]').click();
      }
      function targetMonth_this(){
        var targetMonth = JSON.parse(localStorage.getItem( (btoa(location.href)).slice(0, 16) + '.targetMonth' ));
        targetMonth = {
          year: getTimer()['year'],
          month: getTimer()['month'],
        }
        localStorage.setItem( (btoa(location.href)).slice(0, 16) + '.targetMonth', JSON.stringify(targetMonth) );
        $('a[href="#page_reload"]').click();
      }
    </script>
    <script type="text/javascript">
      $(function(){
        $('a.month_next').click(function(){ targetMonth_shift(0); });
        $('a.month_prev').click(function(){ targetMonth_shift(1); });
        $('a.month_this').click(function(){ targetMonth_this();   });
      });
    </script>
    <script type="text/javascript">
      $(function(){
        var targetMonth = JSON.parse(localStorage.getItem( (btoa(location.href)).slice(0, 16) + '.targetMonth' ));
        if (!targetMonth) {
          targetMonth = {
            year: getTimer()['year'],
            month: getTimer()['month'],
          }
          localStorage.setItem( (btoa(location.href)).slice(0, 16) + '.targetMonth', JSON.stringify(targetMonth) );
        }

        $('#timetable h1').text( Number(targetMonth['month']) + '月' + ' ' + Number(targetMonth['year']) );

        // 本体生成
        $('#kintai_timetable').append('<tbody />');

        // 日付ごとに子供生成
        for (var tbody_date = 1; tbody_date <= new Date(Number(targetMonth['year']), Number(targetMonth['month']), 0).getDate(); tbody_date++) {
          tbody_date_str = ('0' + tbody_date).slice(-2);

          // ja-JP 表記で曜日を取得
          tbody_date_str_day = ['日', '月', '火', '水', '木', '金', '土'][
            new Date(
              Number(targetMonth['year']),
              Number(targetMonth['month']) - 1,
              Number(tbody_date_str)
            ).getDay()
          ];
          var prev_day = new Date(
            Number(targetMonth['year']),
            Number(targetMonth['month']) - 1,
            Number(tbody_date_str) - 1
          );

          // 孫生成
          $('#kintai_timetable').children('tbody').append('<tr />');

          // その日の日付オブジェクト
          var targetDate = new Date(
            Number(targetMonth['year']),
            Number(targetMonth['month']) - 1,
            Number(tbody_date_str)
          );

          if(false){}
          else if( targetDate.toDateString() == (new Date()).toDateString() ){ /* 今日 */
            $('#kintai_timetable tbody tr:last-child').addClass('day_today');
          }
          else if( targetDate.getDay() == 0 ){ /* 日曜日 */
            $('#kintai_timetable tbody tr:last-child').addClass('day_sunday');
          }
          else if( targetDate.getDay() == 6 ){ /* 土曜日 */
            $('#kintai_timetable tbody tr:last-child').addClass('day_saturday');
          }

          // ひ孫生成
          $('#kintai_timetable tbody tr:last-child').append('<td />');
          $('#kintai_timetable tbody tr:last-child td:last-child').text(Number(targetMonth['month']) + '/' + tbody_date_str + '('+tbody_date_str_day+')');
          $('#kintai_timetable tbody tr:last-child td:last-child').append('<input />');
          $('#kintai_timetable tbody tr:last-child td:last-child input').attr({type: 'hidden'});
          $('#kintai_timetable tbody tr:last-child td:last-child input').val( targetMonth['year'] + targetMonth['month'] + tbody_date_str );

          // 始業時間
          $('#kintai_timetable tbody tr:last-child').append('<td />');
          $('#kintai_timetable tbody tr:last-child td:last-child').html('<input />:<input /><input />');
          $('#kintai_timetable tbody tr:last-child td:last-child input').eq(0).attr({
            type: 'tel', maxlength: 2,
            name: 'shigyo_h_' + tbody_date_str,
          }).addClass('timer_io timer_hour');
          $('#kintai_timetable tbody tr:last-child td:last-child input').eq(1).attr({
            type: 'tel', maxlength: 2,
            name: 'shigyo_m_' + tbody_date_str,
          }).addClass('timer_io timer_min');
          $('#kintai_timetable tbody tr:last-child td:last-child input').eq(2).attr({
            type: 'hidden',
            name: 'shigyo_' + tbody_date_str,
          });

          // 終業時間
          $('#kintai_timetable tbody tr:last-child').append('<td />');
          $('#kintai_timetable tbody tr:last-child td:last-child').html('<input />:<input /><input />');
          $('#kintai_timetable tbody tr:last-child td:last-child input').eq(0).attr({
            type: 'tel', maxlength: 2,
            name: 'syugyo_h_' + tbody_date_str,
          }).addClass('timer_io timer_hour');
          $('#kintai_timetable tbody tr:last-child td:last-child input').eq(1).attr({
            type: 'tel', maxlength: 2,
            name: 'syugyo_m_' + tbody_date_str,
          }).addClass('timer_io timer_min');
          $('#kintai_timetable tbody tr:last-child td:last-child input').eq(2).attr({
            type: 'hidden',
            name: 'syugyo_' + tbody_date_str,
          });

          // 休憩時間1
          $('#kintai_timetable tbody tr:last-child').append('<td />');
          $('#kintai_timetable tbody tr:last-child td:last-child').html('<input />:<input /><input />');
          $('#kintai_timetable tbody tr:last-child td:last-child input').eq(0).attr({
            type: 'tel', maxlength: 2,
            name: 'kyukei_1_h_' + tbody_date_str,
          }).addClass('timer_io timer_hour timer_refresh');
          $('#kintai_timetable tbody tr:last-child td:last-child input').eq(1).attr({
            type: 'tel', maxlength: 2,
            name: 'kyukei_1_m_' + tbody_date_str,
          }).addClass('timer_io timer_min timer_refresh');
          $('#kintai_timetable tbody tr:last-child td:last-child input').eq(2).attr({
            type: 'hidden',
            name: 'kyukei_1_' + tbody_date_str,
          });

          // 休憩時間2
          $('#kintai_timetable tbody tr:last-child').append('<td />');
          $('#kintai_timetable tbody tr:last-child td:last-child').html('<input />:<input /><input />');
          $('#kintai_timetable tbody tr:last-child td:last-child input').eq(0).attr({
            type: 'tel', maxlength: 2,
            name: 'kyukei_2_h_' + tbody_date_str,
          }).addClass('timer_io timer_hour timer_refresh');
          $('#kintai_timetable tbody tr:last-child td:last-child input').eq(1).attr({
            type: 'tel', maxlength: 2,
            name: 'kyukei_2_m_' + tbody_date_str,
          }).addClass('timer_io timer_min timer_refresh');
          $('#kintai_timetable tbody tr:last-child td:last-child input').eq(2).attr({
            type: 'hidden',
            name: 'kyukei_2_' + tbody_date_str,
          });

          // 小計勤務時間
          $('#kintai_timetable tbody tr:last-child').append('<td />');
          $('#kintai_timetable tbody tr:last-child td:last-child').html('<output />');
          $('#kintai_timetable tbody tr:last-child td:last-child output').eq(0).attr({
            name: 'total_' + tbody_date_str,
          }).addClass('timer_io timer_total').text('00:00');

          // シフト時間
          $('#kintai_timetable tbody tr:last-child').append('<td />');
          $('#kintai_timetable tbody tr:last-child td:last-child').html('<input /><img /><img />');
          $('#kintai_timetable tbody tr:last-child td:last-child input').eq(0).attr({
            type: 'text',
            readonly: true,
            name: 'workshift_' + tbody_date_str,
          }).addClass('timer_workshift');
          $('#kintai_timetable tbody tr:last-child td:last-child img').eq(0).attr({
            alt: '入力', src: './lib/icon/icon_edit.png',
            name: 'shifttime_input_' + tbody_date_str,
          }).addClass('dataicon rotationicon shifttime_input');
          $('#kintai_timetable tbody tr:last-child td:last-child img').eq(1).attr({
            alt: '複製', src: './lib/icon/icon_copy.png',
            name: 'shifttime_copy_' + tbody_date_str,
          }).addClass('dataicon rotationicon shifttime_copy');

          // 備考
          $('#kintai_timetable tbody tr:last-child').append('<td />');
          $('#kintai_timetable tbody tr:last-child td:last-child').html('<input />');
          $('#kintai_timetable tbody tr:last-child td:last-child input').eq(0).attr({
            type: 'text', maxlength: 64,
            name: 'bikou_' + tbody_date_str,
          });

          // 入力データ消去
          $('#kintai_timetable tbody tr:last-child td:last-child').append('<img />');
          $('#kintai_timetable tbody tr:last-child td:last-child img').eq(0).attr({
            alt: '', src: './lib/icon/icon_cross.png',
            name: 'datareset_' + tbody_date_str,
          }).addClass('dataicon rotationicon datareset');
        }// 孫生成for{}

      });
    </script>
    <script type="text/javascript">
      $(function(){/* 祝日チェック */
        var targetMonth = JSON.parse(localStorage.getItem( (btoa(location.href)).slice(0, 16) + '.targetMonth' ));
        if (!targetMonth) {
          targetMonth = {
            year: getTimer()['year'],
            month: getTimer()['month'],
          }
          localStorage.setItem( (btoa(location.href)).slice(0, 16) + '.targetMonth', JSON.stringify(targetMonth) );
        }

        // 祝日チェック
        $('#kintai_timetable tbody tr td:first-child input').map(function(index_dom, dom){
          // 祝日一覧取得する
          $.ajax({
            type: 'GET',
            url: 'https://holidays-jp.github.io/api/v1/date.json',
            async: true,
            cache: true,
            contentType: false,
            dataType: 'text',
          }).done(function(responce){
            $.map(JSON.parse(responce.replace(/-/g, '')), function(arr, index_arr){
              // 取得したので、日付書式を合わせる
              if( index_arr.slice(0,4) == targetMonth['year'] && index_arr.slice(4,6) == targetMonth['month'] ) {
                // 対象付きのみ処理
                if( targetMonth['year'] + targetMonth['month'] + ('00'+(index_dom+1)).slice(-2) == index_arr ){
                  $('#kintai_timetable tbody tr:nth-child('+(index_dom+1)+')').addClass('day_holiday');
                  $('#kintai_timetable tbody tr:nth-child('+(index_dom+1)+') td:last-child input:first-child').attr({
                    title: arr,
                    placeholder: arr,
                  });
                }
              }
            });
          });
        });
      });
    </script>
    <script type="text/javascript">
      $(function(){
        $('a[href="#page_reload"]').click(function(){
          var href = location.href;
          href = href.replace(/\#.*/g, '');
          href = href.replace(/\?.*/g, '');
          location.replace( href );
        });

        $('a[href="#data_load"]').click(function(){
          $('#menu_bar').slideUp();

          var targetMonth = JSON.parse(localStorage.getItem( (btoa(location.href)).slice(0, 16) + '.targetMonth' ));
          if (!targetMonth) {
            targetMonth = {
              year: getTimer()['year'],
              month: getTimer()['month'],
            }
            localStorage.setItem( (btoa(location.href)).slice(0, 16) + '.targetMonth', JSON.stringify(targetMonth) );
          }

          var saveData = localStorage.getItem( ((btoa(location.href)).slice(0, 16) + '.saveData' + targetMonth['year'] + targetMonth['month']) );
          saveData = JSON.parse(saveData);
          if (!saveData) {
            console.error('Unable to load the save data.');
          } else {
            /* シフト時間 */
            // 始業時間
            $('input[name=workshift_shigyo_h]').val( ( '00' + ( (saveData['timetable_data'][0][0]).split(':')[0] ) ).slice(-2) );
            $('input[name=workshift_shigyo_m]').val( ( '00' + ( (saveData['timetable_data'][0][0]).split(':')[1] ) ).slice(-2) );
            // 終業時間
            $('input[name=workshift_syugyo_h]').val( ( '00' + ( (saveData['timetable_data'][0][1]).split(':')[0] ) ).slice(-2) );
            $('input[name=workshift_syugyo_m]').val( ( '00' + ( (saveData['timetable_data'][0][1]).split(':')[1] ) ).slice(-2) );
            // 休憩時間-1
            $('input[name=workshift_kyukei_1_h]').val( ( '00' + ( (saveData['timetable_data'][0][2]).split(':')[0] ) ).slice(-2) );
            $('input[name=workshift_kyukei_1_m]').val( ( '00' + ( (saveData['timetable_data'][0][2]).split(':')[1] ) ).slice(-2) );
            // 休憩時間-2
            $('input[name=workshift_kyukei_2_h]').val( ( '00' + ( (saveData['timetable_data'][0][3]).split(':')[0] ) ).slice(-2) );
            $('input[name=workshift_kyukei_2_m]').val( ( '00' + ( (saveData['timetable_data'][0][3]).split(':')[1] ) ).slice(-2) );
            // 勤務形態
            $('select[name=workshift_worktype]').val( (saveData['timetable_data'][0][4]) );

            var sectionId = '01';
            for (
              var tbody_date = 1;
              tbody_date <= new Date(Number(targetMonth['year']), Number(targetMonth['month']), 0).getDate();
              tbody_date++
            ) {
              sectionId = ('00'+tbody_date).slice(-2);

              //console.log( saveData['timetable_data'][tbody_date][1] ); /* 勤怠データ */
              //console.log( saveData['timetable_data'][tbody_date][2] ); /* 当日のシフト */
              //console.log( saveData['timetable_data'][tbody_date][3] ); /* 備考 */

              /* 勤怠データ(時間) もしくは 備考 が入力されていない場合は Skip */
              var importskip_check = 0;
              for (var i = 0; i < saveData['timetable_data'][tbody_date][1].length; i++) {
                /* 勤怠データ(時間) */
                importskip_check += saveData['timetable_data'][tbody_date][1][i];
              }
              if (importskip_check > 0) {
                // 始業時間
                $('input[name=shigyo_h_' + sectionId + ']').val( ( '00' + ( parseInt(saveData['timetable_data'][tbody_date][1][0] / 60) ) ).slice(-2) );
                $('input[name=shigyo_m_' + sectionId + ']').val( ( '00' + ( parseInt(saveData['timetable_data'][tbody_date][1][0] % 60) ) ).slice(-2) );

                // 終業時間
                $('input[name=syugyo_h_' + sectionId + ']').val( ( '00' + ( parseInt(saveData['timetable_data'][tbody_date][1][1] / 60) ) ).slice(-2) );
                $('input[name=syugyo_m_' + sectionId + ']').val( ( '00' + ( parseInt(saveData['timetable_data'][tbody_date][1][1] % 60) ) ).slice(-2) );

                // 休憩時間-1
                $('input[name=kyukei_1_h_' + sectionId + ']').val( ( '00' + ( parseInt(saveData['timetable_data'][tbody_date][1][2] / 60) ) ).slice(-2) );
                $('input[name=kyukei_1_m_' + sectionId + ']').val( ( '00' + ( parseInt(saveData['timetable_data'][tbody_date][1][2] % 60) ) ).slice(-2) );

                // 休憩時間-2
                $('input[name=kyukei_2_h_' + sectionId + ']').val( ( '00' + ( parseInt(saveData['timetable_data'][tbody_date][1][3] / 60) ) ).slice(-2) );
                $('input[name=kyukei_2_m_' + sectionId + ']').val( ( '00' + ( parseInt(saveData['timetable_data'][tbody_date][1][3] % 60) ) ).slice(-2) );

                // 勤務時間
                $('output[name=total_' + sectionId + ']').val(''
                  + ( '00' +
                    parseInt(
                      (
                        ( saveData['timetable_data'][tbody_date][1][1] - saveData['timetable_data'][tbody_date][1][0] ) - (
                          saveData['timetable_data'][tbody_date][1][2] + saveData['timetable_data'][tbody_date][1][3]
                        )
                      ) / 60
                    )
                  ).slice(-2)
                  + ':'
                  + ( '00' +
                    parseInt(
                      (
                        ( saveData['timetable_data'][tbody_date][1][1] - saveData['timetable_data'][tbody_date][1][0] ) - (
                          saveData['timetable_data'][tbody_date][1][2] + saveData['timetable_data'][tbody_date][1][3]
                        )
                      ) % 60
                    )
                  ).slice(-2)
                );
              }

              // シフト時間/シフト休/明け休/振り休 など
              if ( (saveData['timetable_data'][tbody_date][2]).length > 0 ) {
                $('input[name=workshift_' + sectionId + ']').val( (saveData['timetable_data'][tbody_date][2]) );
              }

              // 備考
              if ( (saveData['timetable_data'][tbody_date][3]).length > 0 ) {
                $('input[name=bikou_' + sectionId + ']').val( (saveData['timetable_data'][tbody_date][3]) );
              }
            }

          }
        });

        $('a[href="#data_save"]').click(function(){
          $('#menu_bar').slideUp();

          var targetMonth = JSON.parse(localStorage.getItem( (btoa(location.href)).slice(0, 16) + '.targetMonth' ));
          if (!targetMonth) {
            targetMonth = {
              year: getTimer()['year'],
              month: getTimer()['month'],
            }
            localStorage.setItem( (btoa(location.href)).slice(0, 16) + '.targetMonth', JSON.stringify(targetMonth) );
          }
          // save the data is below
          // - timetable data
          // - google oauth credential
          var saveData = [];
          var enviromentData = [];
          var sectionId = '01';

          /* <userData> */
            saveData.push(
              [
                ( $('input[name=workshift_shigyo_h]').val() + ':' + $('input[name=workshift_shigyo_m]').val() ),
                ( $('input[name=workshift_syugyo_h]').val() + ':' + $('input[name=workshift_syugyo_m]').val() ),
                ( $('input[name=workshift_kyukei_1_h]').val() + ':' + $('input[name=workshift_kyukei_1_m]').val() ),
                ( $('input[name=workshift_kyukei_2_h]').val() + ':' + $('input[name=workshift_kyukei_2_m]').val() ),
                ( '' + $('select[name=workshift_worktype] option:selected').val() ).replace('undefined', ''),
              ],
            );

            for (
              var tbody_date = 1;
              tbody_date <= new Date(Number(targetMonth['year']), Number(targetMonth['month']), 0).getDate();
              tbody_date++
            ) {
              sectionId = ('00'+tbody_date).slice(-2);
              saveData.push(
                  [
                    targetMonth['year'] + '/' + targetMonth['month'] + '/' + sectionId,
                    [
                      ( Number( $('input[name=shigyo_h_'   + sectionId + ']').val() ) * 60 ) + Number( $('input[name=shigyo_m_'   + sectionId + ']').val() ),
                      ( Number( $('input[name=syugyo_h_'   + sectionId + ']').val() ) * 60 ) + Number( $('input[name=syugyo_m_'   + sectionId + ']').val() ),
                      ( Number( $('input[name=kyukei_1_h_' + sectionId + ']').val() ) * 60 ) + Number( $('input[name=kyukei_1_m_' + sectionId + ']').val() ),
                      ( Number( $('input[name=kyukei_2_h_' + sectionId + ']').val() ) * 60 ) + Number( $('input[name=kyukei_2_m_' + sectionId + ']').val() ),
                    ],
                    ( '' + $('input[name=workshift_' + sectionId + ']').val() ).replace('undefined', ''),
                    ( '' + $('input[name=bikou_'     + sectionId + ']').val() ),
                  ]
              );
            }

            saveData = {
              'timetable_data': saveData,
            };
          /* </userData> */

          google_oauth_token = '';
          enviromentData = {
            'google_oauth_token': google_oauth_token,
          };
          console.log(saveData);
          localStorage.setItem( ((btoa(location.href)).slice(0, 16) + '.saveData' + targetMonth['year'] + targetMonth['month']), JSON.stringify(saveData) );
          localStorage.setItem( ((btoa(location.href)).slice(0, 16) + '.envData' + targetMonth['year'] + targetMonth['month']), JSON.stringify(enviromentData) );

          alert('Saved!!');
        });

        $('a[href="#conf_reset"]').click(function(){
          localStorage.clear();
          $('a[href="#page_reload"]').click();
        });

        $('a[href="#conf_setup"]').click(function(){
          $('#menu_bar').slideUp();

          // メニューアイコンサイズ調整
          $('input[name="Menu_icon_size"]').val(
            localStorage.getItem( (btoa(location.href)).slice(0, 16) + '.ini_Menu_icon_size' )
          );
          $('input[name="Menu_icon_size"]').next().text(
            parseInt(
              localStorage.getItem( (btoa(location.href)).slice(0, 16) + '.ini_Menu_icon_size' )
            )
          );

          // Google recaptcha 可視性調整
          $('input[name="Google_recaptcha_visibility"]').val(
            localStorage.getItem( (btoa(location.href)).slice(0, 16) + '.ini_Google_recaptcha_visibility' )
          );
          $('input[name="Google_recaptcha_visibility"]').next().text(
            parseFloat(
              localStorage.getItem( (btoa(location.href)).slice(0, 16) + '.ini_Google_recaptcha_visibility' )
            ).toFixed(1)
          );

          $('#menu_config_bar').fadeIn('slow');
        });

        $('#menu_config_bar_close').click(function(){
          $('#menu_config_bar').fadeOut('slow');
        });

        $('a[href="#data_submit"]').click(function(){
          $('#menu_bar').slideUp();

          var targetMonth = JSON.parse(localStorage.getItem( (btoa(location.href)).slice(0, 16) + '.targetMonth' ));
          if (!targetMonth) {
            targetMonth = {
              year: getTimer()['year'],
              month: getTimer()['month'],
            }
            localStorage.setItem( (btoa(location.href)).slice(0, 16) + '.targetMonth', JSON.stringify(targetMonth) );
          }

          var sectionId = '01';
          var shifttime_01string = (
              $('input[name=workshift_shigyo_h]').val() + $('input[name=workshift_shigyo_m]').val()
            + $('input[name=workshift_syugyo_h]').val() + $('input[name=workshift_syugyo_m]').val()
          )
          $('input[name=bikou_' + sectionId + ']').val(
            (
              shifttime_01string
              + ' ' + ( $('input[name=bikou_' + sectionId + ']').val() ).replace(shifttime_01string, '')
            ).trim().replace(/ +/g, ' ')
          );

          console.log([
            '日付',
            '始業時刻',
            '終業時刻',
            '休憩時間',
            '休憩時間(深夜)',
            '残業時間',
            '深夜時間',
            '合計',
            '備考',
          ]);
          var worktime = [];
          for (
            var tbody_date = 1;
            tbody_date <= new Date(Number(targetMonth['year']), Number(targetMonth['month']), 0).getDate();
            tbody_date++
          ) {
            sectionId = ('00'+tbody_date).slice(-2);
            worktime = ([
              /* 0 * 日付 */ targetMonth['year'] + '/' + targetMonth['month'] + '/' + sectionId,
              /* 1 * 始業時刻 */ Number( $('input[name=shigyo_'   + sectionId + ']').val() ),
              /* 2 * 終業時刻 */ Number( $('input[name=syugyo_'   + sectionId + ']').val() ),
              /* 3 * 休憩時間 */ Number( $('input[name=kyukei_1_' + sectionId + ']').val() ),
              /* 4 * 休憩時間(深夜) */ Number( $('input[name=kyukei_2_' + sectionId + ']').val() ),
              /* 5 * 残業時間 */ 0,
              /* 6 * 深夜時間 */ 0,
              /* 7 * 合計 */ (
                    Number( $('input[name=syugyo_'   + sectionId + ']').val() ) - Number( $('input[name=shigyo_'   + sectionId + ']').val() )
                - ( Number( $('input[name=kyukei_1_' + sectionId + ']').val() ) + Number( $('input[name=kyukei_2_' + sectionId + ']').val() ) )
              ),
              /* 8 * 備考 */ $('input[name=bikou_' + sectionId + ']').val(),
            ]);

            worktime[5] /* 残業時間 */ = ( worktime[7] - ( /* シフトの時間 */
                  Number( ( ( Number($('input[name=workshift_syugyo_h]').val())   * 60 ) + Number($('input[name=workshift_syugyo_m]').val())   ) ) - Number( ( ( Number($('input[name=workshift_shigyo_h]').val())   * 60 ) + Number($('input[name=workshift_shigyo_m]').val())   ) )
              - ( Number( ( ( Number($('input[name=workshift_kyukei_1_h]').val()) * 60 ) + Number($('input[name=workshift_kyukei_1_m]').val()) ) ) + Number( ( ( Number($('input[name=workshift_kyukei_2_h]').val()) * 60 ) + Number($('input[name=workshift_kyukei_2_m]').val()) ) ) )
            ) );
            if (worktime[5] < 0) { worktime[5] = 0; }

            console.log(worktime);

            for (var i = 1; i <= 7; i++) {
              // 計算しなくていいとこは飛ばす
              if (false) {}
              else if ( i == 6) { continue; }

              // 時間データを hh:mm に変換
              worktime[i] = ( ( '00' + parseInt( ( Number(worktime[i]) ) / 60 ) ).slice(-2) ) + ':' + ( ( '00' + parseInt( ( Number(worktime[i]) ) % 60 ) ).slice(-2) )
            }
            console.log(worktime);
          }

        });

        $('a[href="#data_export"]').click(function(){
          $('#menu_bar').slideUp();

          var targetMonth = JSON.parse(localStorage.getItem( (btoa(location.href)).slice(0, 16) + '.targetMonth' ));
          if (!targetMonth) {
            targetMonth = {
              year: getTimer()['year'],
              month: getTimer()['month'],
            }
            localStorage.setItem( (btoa(location.href)).slice(0, 16) + '.targetMonth', JSON.stringify(targetMonth) );
          }

          var saveData = localStorage.getItem( ((btoa(location.href)).slice(0, 16) + '.saveData' + targetMonth['year'] + targetMonth['month']) );

          /* Control the Blob on the Jquery https://www.sejuku.net/blog/67735 */
          var blobdata = new Blob([saveData], {type: 'text/plain'});

          $(this).attr({
            download: ((btoa(location.href)).slice(0, 16) + '.saveData' + '.' + targetMonth['year'] + targetMonth['month']) + parseInt((new Date()).getTime()/1000) + '.txt',
            href: window.URL.createObjectURL(blobdata),
          });
        });

        $('a[href="#data_import"]').click(function(){
          $('#menu_bar').slideUp();

          var targetMonth = JSON.parse(localStorage.getItem( (btoa(location.href)).slice(0, 16) + '.targetMonth' ));
          if (!targetMonth) {
            targetMonth = {
              year: getTimer()['year'],
              month: getTimer()['month'],
            }
            localStorage.setItem( (btoa(location.href)).slice(0, 16) + '.targetMonth', JSON.stringify(targetMonth) );
          }



        });

      });
    </script>
    <script type="text/javascript">
      $(function(){
        $('input.timer_io').focus(function(){
          $(this).select();
        });
        $('input.timer_io').blur(function(){
          $(this).change();
        });
        $('input.timer_io').change(function(){
          console.log($(this));
          /* 全角数字を半角数字に変える */
          $(this).val( ($(this).val()).replace(/[０-９]/g, function(s) {
            return String.fromCharCode(s.charCodeAt(0) - 0xFEE0);
          }) );

          /* 数字以外を削除 */
          $(this).val( ($(this).val()).replace(/[^0-9]/g, '') );

          /* 数字 1桁 を 2桁 にする */
          $(this).val( ( '00' + $(this).val() ).slice(-2) );

        });
        $('input.timer_io:not(input[name^=workshift_])').change(function(){
          var sectionId = $(this).attr('name').slice(-2);
          $('input[name=shigyo_'+sectionId+']').val(
              Number( $('input[name=shigyo_h_' + sectionId + ']').val()   * 60 )
            + Number( $('input[name=shigyo_m_' + sectionId + ']').val()        )
          );
          if ($('input[name=shigyo_h_' + sectionId + ']').val() == '') {
            $('input[name=shigyo_m_' + sectionId + ']').val('');
          }

          $('input[name=syugyo_'+sectionId+']').val(
              Number( $('input[name=syugyo_h_' + sectionId + ']').val()   * 60 )
            + Number( $('input[name=syugyo_m_' + sectionId + ']').val()        )
          );
          if ($('input[name=syugyo_h_' + sectionId + ']').val() == '') {
            $('input[name=syugyo_m_' + sectionId + ']').val('');
          }

          $('input[name=kyukei_1_'+sectionId+']').val(
              Number( $('input[name=kyukei_1_h_' + sectionId + ']').val() * 60 )
            + Number( $('input[name=kyukei_1_m_' + sectionId + ']').val()      )
          );
          if ($('input[name=kyukei_1_h_' + sectionId + ']').val() == '') {
            $('input[name=kyukei_1_m_' + sectionId + ']').val('');
          }

          $('input[name=kyukei_2_'+sectionId+']').val(
              Number( $('input[name=kyukei_2_h_' + sectionId + ']').val() * 60 )
            + Number( $('input[name=kyukei_2_m_' + sectionId + ']').val()      )
          );
          if ($('input[name=kyukei_2_h_' + sectionId + ']').val() == '') {
            $('input[name=kyukei_2_m_' + sectionId + ']').val('');
          }

          // 数値チェック
          var shigyo_time = Number( $('input[name=shigyo_'   + sectionId + ']').val() );
          var syugyo_time = Number( $('input[name=syugyo_'   + sectionId + ']').val() );
          var kyukei_1    = Number( $('input[name=kyukei_1_' + sectionId + ']').val() );
          var kyukei_2    = Number( $('input[name=kyukei_2_' + sectionId + ']').val() );
          var work_time   = 0;
          $('#kintai_timetable tbody tr:nth-child('+sectionId+') input.timer_io').removeClass('err_validation');

          // 終業時間が 始業時間と同じもしくはそれ以下 の場合 -> エラー表示
          if ( Number(syugyo_time) <= Number(shigyo_time) ){
            $('#kintai_timetable tbody tr:nth-child('+sectionId+') input.timer_io').addClass('err_validation');
          }

          // 終業時間と始業時間が　文字なし の場合 -> エラー表示解除
          if ( ( syugyo_time == '' ) && ( shigyo_time == '' ) ) {
            $('#kintai_timetable tbody tr:nth-child('+sectionId+') input.timer_io').removeClass('err_validation');
            $('input[name=kyukei_1_h_' + sectionId + ']').val('');
            $('input[name=kyukei_1_m_' + sectionId + ']').val('');
            $('input[name=kyukei_2_h_' + sectionId + ']').val('');
            $('input[name=kyukei_2_m_' + sectionId + ']').val('');
          }

          //
          work_time = ( syugyo_time - shigyo_time ) - ( kyukei_1 + kyukei_2 );
          work_time = ( '00' + parseInt( work_time / 60 ) ).slice(-2) + ':' + ( '00' + parseInt( work_time % 60 ) ).slice(-2);
          $('output[name=total_' + sectionId + ']').text( work_time );

          console.log(sectionId
            + '   ' + ''
            + '   ' + shigyo_time
            + '   ' + syugyo_time
            + '   ' + kyukei_1
            + '   ' + kyukei_2
            + '   ' + '|'
            + '   ' + $('input[name=shigyo_'   + sectionId + ']').val()
            + '   ' + $('input[name=syugyo_'   + sectionId + ']').val()
            + '   ' + $('input[name=kyukei_1_' + sectionId + ']').val()
            + '   ' + $('input[name=kyukei_2_' + sectionId + ']').val()
          );
        });

        $('input.timer_hour').change(function(){
          if ($(this).val() >= 48) { $(this).val(0); }/* Out of range */
        });
        $('input.timer_min').change(function(){
          /*
           * quote: https://qiita.com/shuuuuun/items/f0031d710ca50b21177a
           * 配列から最も近い値(近似値)を探す
           */

          var value = $(this).val();
          if (value != '') {
            const minslist = [0, 15, 30, 45];
            var diff = [];
            var index = 0;

            $(minslist).each(function(i,val){
              diff[i] = Math.abs(value - val);
              index = (diff[index] < diff[i]) ? index : i;
            });

            $(this).val( ( '00' + minslist[index] ).slice(-2) );
          }
        });
        $('input.timer_hour:not(.timer_refresh)').focus(function(){
          /* blank のときは今の時間を代入 */
          if ($(this).val()=='') { $(this).val(getTimer()['hour']); }
          $(this).change();
        });
        $('input').change(function(){
          $('input:not(input[type=button])').map(function(index, element){
            //console.log({name: element.name, value: element.value});
          });
        });

        $('img.rotationicon').click(function(){
          var dataobject = $(this);
          $({deg:0}).animate({deg:360}, {
            duration: 1000,
            easing: 'swing',

            // 途中経過
            progress:function() {
              dataobject.css({
                transform:'rotate(' + this.deg + 'deg)'
              });
            },

            // アニメーション完了
            complete:function() {}
          });
        });
        $('img.shifttime_copy').click(function(){
          var dataobject = $(this);

          var sectionId = ('00'+dataobject.attr('name')).slice(-2);

          $('input[name=shigyo_h_'   + sectionId + ']').val( $('input[name="workshift_shigyo_h"]').val() );
          $('input[name=shigyo_m_'   + sectionId + ']').val( $('input[name="workshift_shigyo_m"]').val() );
          $('input[name=syugyo_h_'   + sectionId + ']').val( $('input[name="workshift_syugyo_h"]').val() );
          $('input[name=syugyo_m_'   + sectionId + ']').val( $('input[name="workshift_syugyo_m"]').val() );
          $('input[name=kyukei_1_h_' + sectionId + ']').val( $('input[name="workshift_kyukei_1_h"]').val() );
          $('input[name=kyukei_1_m_' + sectionId + ']').val( $('input[name="workshift_kyukei_1_m"]').val() );
          $('input[name=kyukei_2_h_' + sectionId + ']').val( $('input[name="workshift_kyukei_2_h"]').val() );
          $('input[name=kyukei_2_m_' + sectionId + ']').val( $('input[name="workshift_kyukei_2_m"]').val() );
          $('input[name=workshift_'  + sectionId + ']').val(
            (
                $('input[name="workshift_shigyo_h"]').val()
              + $('input[name="workshift_shigyo_m"]').val()
              + $('input[name="workshift_syugyo_h"]').val()
              + $('input[name="workshift_syugyo_m"]').val()
            ).replace(/:/g, '')
          );

          $('#kintai_timetable tbody tr:nth-child('+sectionId+') input.timer_io').change();
        });
        $('img.shifttime_input').click(function(){
          var dataobject = $(this);

          var sectionId = ('00'+dataobject.attr('name')).slice(-2);

          if (!$('input[name=workshift_'  + sectionId + ']').attr('readonly')) {
            $('input[name=workshift_'  + sectionId + ']').attr('readonly', true);
          } else {
            $('input[name=workshift_'  + sectionId + ']').attr('readonly', false);
          }
        });
        $('img.datareset').click(function(){
          var dataobject = $(this);
          var sectionId = ('00'+dataobject.attr('name')).slice(-2);

          console.log($('#kintai_timetable tbody tr:nth-child('+sectionId+') input:not([type=button])'));

          $('#kintai_timetable tbody tr:nth-child('+sectionId+') input').val('');
          $('#kintai_timetable tbody tr:nth-child('+sectionId+') input').map(function(index_dom, dom){
            dom.className = (dom.className).replace(/err_.*/, '');
          });
          $('#kintai_timetable tbody tr:nth-child('+sectionId+') output').val('00:00');
        });

      });
    </script>
    <script type="text/javascript">
      $(function(){
        // メニューアイコンサイズ調整
        $('input[name="Menu_icon_size"]').on('input', function(){
          $(this).next().text( (parseInt(this.value)) );
          $('#menu_opener img').css({
            height: parseInt(this.value),
            width: parseInt(this.value),
          });
          localStorage.setItem( (btoa(location.href)).slice(0, 16) + '.ini_Menu_icon_size', parseInt(this.value) );
        });

        // Google recaptcha 可視性調整
        $('input[name="Google_recaptcha_visibility"]').on('input', function(){
          $(this).next().text( (parseFloat(this.value)).toFixed(1) );
          $('.grecaptcha-badge').css('opacity', parseFloat(this.value));
          localStorage.setItem( (btoa(location.href)).slice(0, 16) + '.ini_Google_recaptcha_visibility', parseFloat(this.value) );
        });
      });
    </script>
    <script type="text/javascript">
      $(window).on('load', function(){
        // メニューアイコンサイズ調整
        if(null === localStorage.getItem( (btoa(location.href)).slice(0, 16) + '.ini_Menu_icon_size' )){
          /* default */ localStorage.setItem( (btoa(location.href)).slice(0, 16) + '.ini_Menu_icon_size', 32);
        }
        $('#menu_opener img').css({
          height: localStorage.getItem( (btoa(location.href)).slice(0, 16) + '.ini_Menu_icon_size' ),
          width: localStorage.getItem( (btoa(location.href)).slice(0, 16) + '.ini_Menu_icon_size' ),
        });

        // Google recaptcha 可視性調整
        if(null === localStorage.getItem( (btoa(location.href)).slice(0, 16) + '.ini_Google_recaptcha_visibility' )){
          /* default */ localStorage.setItem( (btoa(location.href)).slice(0, 16) + '.ini_Google_recaptcha_visibility', 1.0);
        }
        $('.grecaptcha-badge').css('opacity', localStorage.getItem( (btoa(location.href)).slice(0, 16) + '.ini_Google_recaptcha_visibility' ) );


        $('a[href="#data_load"]').click();
      });
    </script>
  </head>
  <body>
    <div class="sidemenu" id="menu_opener">
      <a tabindex="-1"><img alt="" src="./lib/icon/icon_menu.png" /></a>
    </div>
    <div class="sidemenu" id="menu_bar">
      <ul>
        <li><a tabindex="-1" href="#page_reload"><img alt="" src="./lib/icon/icon_reload.png" />更新</a></li>
        <li><a tabindex="-1" href="#conf_setup"><img alt="" src="./lib/icon/icon_setup.png" />設定</a></li>
        <li><a tabindex="-1" href="#data_save"><img alt="" src="./lib/icon/icon_save.png" />保存</a></li>
        <li><a tabindex="-1" href="#data_load"><img alt="" src="./lib/icon/icon_load.png" />開く</a></li>
        <li><a tabindex="-1" href="#data_export"><img alt="" src="./lib/icon/icon_export.png" />テキストとして保存</a></li>
        <li><a tabindex="-1" href="#data_import"><img alt="" src="./lib/icon/icon_import.png" />テキストから取込み</a></li>
        <!-- <li><a tabindex="-1" href="#auth_login"><img alt="" src="./lib/icon/icon_login.png" />ログイン</a></li> -->
        <li><a tabindex="-1" href="#data_submit"><img alt="" src="./lib/icon/icon_submit.png" />提出</a></li>
        <li><a tabindex="-1" href="#data_statistics"><img alt="" src="./lib/icon/icon_statistics.png" />統計</a></li>
      </ul>
    </div>
    <div class="sidemenu" id="kintai_timetable_dataImport">

    </div>
    <div class="sidemenu" id="menu_config_bar">
      <div id="menu_config_bar_close"></div>
      <table>
        <tbody>
          <tr>
            <td></td>
            <td><a tabindex="-1" href="#conf_reset">設定とデータをリセット</td>
          </tr>
          <tr>
            <td>Menu icon size</td>
            <td><input type="range" max="70" min="15" step="1" value="1" name="Menu_icon_size" /><output /></td>
          </tr>
          <tr>
            <td>Google recaptcha visibility</td>
            <td><input type="range" max="1" min="0" step="0.1" value="1" name="Google_recaptcha_visibility" /><output /></td>
          </tr>
          <tr>
            <td>Google mail setup</td>
            <td>comming soon</td>
          </tr>
          <tr>
            <td>Account Name</td>
            <td>anonymous</td>
          </tr>
          <tr>
            <td>Mail From</td>
            <td>anonymous</td>
          </tr>
          <tr>
            <td>Mail To</td>
            <td><input type="email" name="Google_mail_sendTo" value="" /></td>
          </tr>
          <tr>
            <td>Mail CC</td>
            <td><input type="email" name="Google_mail_sendCc" value="" /></td>
          </tr>
        </tbody>
      </table>
    </div>

    <div id="timetable">
      <h1></h1>
      <h2>&lt; <a class="month_prev">前月</a> <a class="month_this">今月</a> <a class="month_next">翌月</a> &gt;</h2>
      <table id="kintai_timetable">
        <thead>
          <tr>
            <th>日付</th>
            <th>始業</th>
            <th>終業</th>
            <th>休憩(通常)</th>
            <th>休憩(夜間)</th>
            <th>勤務</th>
            <th>シフト</th>
            <th>備考</th>
          </tr>
          <tr>
            <td>シフト</th>
            <td><input class="timer_io timer_hour" type="tel" maxlength="2" value="09" name="workshift_shigyo_h">:<input class="timer_io timer_min" type="tel" maxlength="2" value="00" name="workshift_shigyo_m"></td>
            <td><input class="timer_io timer_hour" type="tel" maxlength="2" value="18" name="workshift_syugyo_h">:<input class="timer_io timer_min" type="tel" maxlength="2" value="00" name="workshift_syugyo_m"></td>
            <td><input class="timer_io timer_hour" type="tel" maxlength="2" value="01" name="workshift_kyukei_1_h">:<input class="timer_io timer_min" type="tel" maxlength="2" value="00" name="workshift_kyukei_1_m"></td>
            <td><input class="timer_io timer_hour" type="tel" maxlength="2" value="00" name="workshift_kyukei_2_h">:<input class="timer_io timer_min" type="tel" maxlength="2" value="00" name="workshift_kyukei_2_m"></td>
            <td></td>
            <td><select class="" name="workshift_worktype">
              <option value="fixed">固定</option>
              <option value="shift">変形</option>
            </select></td>
            <td></td>
          </tr>
        </thead>
      </table>
    </div>
  </body>
</html>
